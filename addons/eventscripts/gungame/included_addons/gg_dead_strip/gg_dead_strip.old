"""
(c)2007 by the GunGame Coding Team

    Title:      gg_dead_strip
Version #:      11.24.2007
Description:    When a player dies all his weapons are imidiately removed from the game.
"""

import es
import playerlib
import gamethread
from gungame import gungame

# Register this addon with EventScripts
info = es.AddonInfo() 
info.name     = "gg_dead_strip Addon for GunGame: Python" 
info.version  = "11.24.2007"
info.url      = "http://forums.mattie.info/cs/forums/viewforum.php?f=45" 
info.basename = "gungame/included_addons/gg_dead_strip" 
info.author   = "cagemonkey, XE_ManUp, GoodFelladeal, RideGuy, JoeyT2007"


# dict to hold player weapons
dict_playerWeapons = {}
# list of valid weapons
list_allWeapons = ['glock', 'usp', 'p228', 'deagle', 'elite', 'fiveseven', 'awp', 'scout', 'aug', 'mac10', 'tmp', 'mp5navy', 'ump45', 'p90', 'galil', 'famas', 'ak47', 'sg552', 'sg550', 'g3sg1', 'm249', 'm3', 'xm1014', 'm4a1', 'hegrenade', 'flashbang', 'smokegrenade']
# holds the index of the most recently dropped weapon
lastDroppedWeapon = 0


def load():
	# Register this addon with GunGame
	global dict_playerWeapons
	gungame.registerAddon('gungame/included_addons/gg_dead_strip', 'gg_dead_strip')
	players = playerlib.getUseridList("#all")
	for tempid in players:
		userid = str(tempid)
		dict_playerWeapons[userid] = {}

	
def unload():
	# Unregister this addon with GunGame
	gungame.unregisterAddon('gungame/included_addons/gg_dead_strip')
	
	
def player_team(event_var):
	global dict_playerWeapons
	userid = event_var['userid']
	if userid not in dict_playerWeapons:
		dict_playerWeapons[userid] = {}
		
		
def player_disconnect(event_var):
	global dict_playerWeapons
	userid = event_var['userid']
	if userid in dict_playerWeapons:
		del dict_playerWeapons[userid]


def round_start(event_var):
	global dict_playerWeapons
	players = playerlib.getUseridList("#all")
	for tempid in players:
		userid = str(tempid)
		dict_playerWeapons[userid].clear()
		

def item_pickup(event_var):
	gamethread.delayed(0.001, getItemPickup, (event_var['userid'], event_var['item'], event_var['es_username']))
		
		
def getItemPickup(userid, item, username):
	global list_allWeapons
	if item in list_allWeapons:
		global lastDroppedWeapon
		playerlibPlayer = playerlib.getPlayer(userid)
		weaponIndex = playerlibPlayer.get('weaponindex', item)
		if weaponIndex != lastDroppedWeapon:
			global dict_playerWeapons
			dict_playerWeapons[userid][item] = weaponIndex
			print username, dict_playerWeapons[userid]
		
		
def es_client_command(event_var):
	if event_var['command'] == 'drop':
		global dict_playerWeapons
		for item in dict_playerWeapons[userid]:
			if dict_playerWeapons[userid][item] in es.createentitylist(item):
				global lastDroppedWeapon
				lastDroppedWeapon = dict_playerWeapons[userid][item]
				#es.server.cmd('es_xremove %s' % dict_playerWeapons[userid][item])
				es.remove(dict_playerWeapons[userid][item])
				
				
def weapon_fire(event_var):
	if event_var['weapon'] == 'hegrenade':
		del dict_playerWeapons[event_var['userid']]['hegrenade']


def player_death(event_var):
	global dict_playerWeapons
	userid = event_var['userid']
	print event_var['es_username'], dict_playerWeapons[userid]
	playerlibPlayer = playerlib.getPlayer(userid)
	for item in dict_playerWeapons[userid]:
		global lastDroppedWeapon
		lastDroppedWeapon = dict_playerWeapons[userid][item]
		# es.server.cmd('es_xremove %s' % dict_playerWeapons[userid][item])
		es.remove(dict_playerWeapons[userid][item])
		